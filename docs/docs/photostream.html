<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-photostream" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Photo Stream | Doodle Tutorials</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://nacular.github.io/doodle-tutorials/img/site_preview.png"><meta data-rh="true" name="twitter:image" content="https://nacular.github.io/doodle-tutorials/img/site_preview.png"><meta data-rh="true" property="og:url" content="https://nacular.github.io/doodle-tutorials/docs/photostream"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="og:image:width" content="380"><meta data-rh="true" name="og:image:height" content="78"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Photo Stream | Doodle Tutorials"><meta data-rh="true" name="description" content="We will build a simple Doodle app that displays an infinite stream of photos that are lazily loaded from unsplash.com."><meta data-rh="true" property="og:description" content="We will build a simple Doodle app that displays an infinite stream of photos that are lazily loaded from unsplash.com."><link data-rh="true" rel="icon" href="/doodle-tutorials/img/favicon.png"><link data-rh="true" rel="canonical" href="https://nacular.github.io/doodle-tutorials/docs/photostream"><link data-rh="true" rel="alternate" href="https://nacular.github.io/doodle-tutorials/docs/photostream" hreflang="en"><link data-rh="true" rel="alternate" href="https://nacular.github.io/doodle-tutorials/docs/photostream" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KN5YH7BJYG"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KN5YH7BJYG",{anonymize_ip:!0})</script>



<script src="https://unpkg.com/kotlin-playground@1"></script><link rel="stylesheet" href="/doodle-tutorials/assets/css/styles.8934ba38.css">
<script src="/doodle-tutorials/assets/js/runtime~main.baf68e23.js" defer="defer"></script>
<script src="/doodle-tutorials/assets/js/main.2c8e2dcd.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/doodle-tutorials/"><div class="navbar__logo"><img src="/doodle-tutorials/img/doodle.svg" alt="Doodle Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/doodle-tutorials/img/doodle.svg" alt="Doodle Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/nacular/doodle-tutorials" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><a href="https://kotlinlang.slack.com/messages/doodle" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-slack-link" aria-label="Slack channel"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doodle-tutorials/docs/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doodle-tutorials/docs/timedcards">Timed Cards</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doodle-tutorials/docs/tabstrip">Animating Tab Strip</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doodle-tutorials/docs/contacts">Contacts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doodle-tutorials/docs/calculator">Calculator</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doodle-tutorials/docs/todo">Todo</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doodle-tutorials/docs/photos">Photos</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/doodle-tutorials/docs/photostream">Photo Stream</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1><a href="https://github.com/nacular/doodle-tutorials/tree/master/PhotoStream" target="_blank" rel="noopener noreferrer">Photo Stream</a> Tutorial</h1>
<p>We will build a simple Doodle app that displays an infinite stream of photos that are lazily loaded from <a href="https://unsplash.com" target="_blank" rel="noopener noreferrer">unsplash.com</a>.
The photos will be shown in a list that continuously grows as the user scrolls to the bottom.</p>
<div style="text-align:center;margin:3em 0"><video autoplay="" loop="" muted="" playsinline="" width="400px"><source type="video/mp4" src="/doodle-tutorials/photo_stream_desktop.mov"><p>Your browser does not support the video element.</p></video></div>
<p>The first thing we need is an <strong>Unsplash API</strong> key. Take a look at their <a href="https://unsplash.com/documentation" target="_blank" rel="noopener noreferrer">developer documentation</a> to obtain one.
A key is required to make API requests and fetch image urls.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="project-setup">Project Setup<a href="#project-setup" class="hash-link" aria-label="Direct link to Project Setup" title="Direct link to Project Setup">​</a></h2>
<p>We will use a JS only-setup for this app. Our app will use Ktor for the HTTP client and Kotlin Serialization to unmarshal the resulting JSON.
We also need Kotlin&#x27;s Coroutines library to load images asynchronously.</p>
<p><a href="https://github.com/nacular/doodle-tutorials/blob/master/PhotoStream/build.gradle.kts" target="_blank" rel="noopener noreferrer"><strong>build.gradle.kts</strong></a></p>
<code theme="darcula" mode="kotlin" data-highlight-only="true">plugins {
    kotlin(&quot;multiplatform&quot;          )
    alias(libs.plugins.serialization)
}

kotlin {
    // Defined in buildSrc/src/main/kotlin/Common.kt
    jsTargets    (executable = true)
    wasmJsTargets(executable = true)

    sourceSets {
        jsMain {
            dependencies {
                implementation(libs.bundles.ktor.client)
                implementation(libs.coroutines.core    )
                implementation(libs.serialization.json )

                api(libs.doodle.browser )
                api(libs.doodle.controls)
                api(libs.doodle.themes  )
            }
        }
    }
}</code>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-application">The Application<a href="#the-application" class="hash-link" aria-label="Direct link to The Application" title="Direct link to The Application">​</a></h2>
<p>Our application will be fairly simple. It will create a <a href="https://nacular.github.io/doodle/docs/ui_components/overview#list" target="_blank" rel="noopener noreferrer"><code>DynamicList</code></a> with a data model bound to Unsplash&#x27;s APIs. This list will be within a <a href="https://nacular.github.io/doodle-api/core/io.nacular.doodle.controls.panels/-scroll-panel" target="_blank" rel="noopener noreferrer"><code>ScrollPanel</code></a> that fits the <a href="https://nacular.github.io/doodle/docs/display/overview" target="_blank" rel="noopener noreferrer"><code>Display</code></a> height.</p>
<code theme="darcula" mode="kotlin" data-highlight-only="true">package io.nacular.doodle.examples

import io.ktor.client.*
import io.nacular.doodle.application.Application
import io.nacular.doodle.controls.itemVisualizer
import io.nacular.doodle.controls.list.DynamicList
import io.nacular.doodle.controls.panels.ScrollPanel
import io.nacular.doodle.core.Display
import io.nacular.doodle.image.ImageLoader
import io.nacular.doodle.layout.constraints.constrain
import io.nacular.doodle.layout.constraints.fill
import io.nacular.doodle.theme.ThemeManager
import io.nacular.doodle.theme.adhoc.DynamicTheme
import io.nacular.doodle.theme.basic.list.basicVerticalListBehavior
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.SupervisorJob

/**
 * Streams an unbounded list of images from unsplash and displays them in a list.
 */
//sampleStart
class PhotoStreamApp(display    : Display,
                     themes     : ThemeManager,
                     theme      : DynamicTheme,
                     httpClient : HttpClient,
                     imageLoader: ImageLoader): Application {
    init {
        // For scroll panel behavior
        themes.selected = theme

        val appScope    = CoroutineScope(SupervisorJob() + Dispatchers.Default)
        val imageHeight = 400.0

        // List to hold images
        val list = DynamicList(
            model          = UnSplashDataModel(appScope, httpClient, imageLoader),
            itemVisualizer = itemVisualizer { image, recycledView, _ -&gt; when(recycledView) {
                is CenterCroppedPhoto -&gt; recycledView.also { recycledView.image = image }
                else                  -&gt; CenterCroppedPhoto(image)
            } }
        ).apply {
            behavior      = basicVerticalListBehavior(itemHeight = imageHeight)
            cellAlignment = fill
        }

        display += ScrollPanel(list).apply {
            // Ensure list&#x27;s width is equal to scroll-panel&#x27;s
            contentWidthConstraints = { it eq parent.width - verticalScrollBarWidth }
        }

        display.layout = constrain(display.children[0]) {
            it.width   eq min(parent.width, imageHeight)
            it.height  eq parent.height
            it.centerX eq parent.centerX
        }
    }

    override fun shutdown() {}
}
//sampleEnd</code>
<p>DynamicList monitors its model for changes and updates whenever items are added, removed, or moved. This means we can simply change the underlying model to get a list that grows.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><code>DynamicList</code>, like <a href="https://nacular.github.io/doodle-api/controls/io.nacular.doodle.controls.list/-list" target="_blank" rel="noopener noreferrer"><code>List</code></a> and <a href="https://nacular.github.io/doodle-api/controls/io.nacular.doodle.controls.list/-mutable-list" target="_blank" rel="noopener noreferrer"><code>MutableList</code></a> recycle their contents to avoid rendering items that are not displayed. The <code>scrollCache</code> constructor parameter controls the amount of items in the buffer. Passing nothing means we get a default of 10 items cached beyond what is visible.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="binding-to-unsplash-data">Binding To Unsplash Data<a href="#binding-to-unsplash-data" class="hash-link" aria-label="Direct link to Binding To Unsplash Data" title="Direct link to Binding To Unsplash Data">​</a></h2>
<p>DynamicList requires a <a href="https://nacular.github.io/doodle-api/controls/io.nacular.doodle.controls/-dynamic-list-model" target="_blank" rel="noopener noreferrer"><code>DynamicListModel</code></a> to hold its data, so we need to create one that binds to Unsplash.</p>
<code theme="darcula" mode="kotlin" data-highlight-only="true">package io.nacular.doodle.examples

import io.ktor.client.*
import io.ktor.client.call.*
import io.ktor.client.request.*
import io.nacular.doodle.controls.DynamicListModel
import io.nacular.doodle.controls.ModelObserver
import io.nacular.doodle.image.Image
import io.nacular.doodle.image.ImageLoader
import io.nacular.doodle.utils.ObservableList
import io.nacular.doodle.utils.SetPool
import io.nacular.doodle.utils.observable
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Job
import kotlinx.coroutines.launch
import kotlinx.serialization.Serializable
import kotlin.properties.Delegates

/**
 * DynamicListModel of Images that fetches data from Unsplash. This model provides a stream
 * of images by fetching every time the end of its current list is reached. Fetched images
 * are cached in memory.
 */
//sampleStart
class UnSplashDataModel(
    private val scope      : CoroutineScope,
    private val client     : HttpClient,
    private val imageLoader: ImageLoader,
    private val accessToken: String = &quot;YOUR_ACCESS_TOKEN&quot;
): DynamicListModel&lt;Image&gt; {
    @Serializable
    data class Urls(val small: String)

    @Serializable
    data class UnsplashPhoto(val id: String, val urls: Urls)

    // Tracks current HTTP request
    private var httpRequestJob: Job? by Delegates.observable(null) { _, old, _ -&gt;
        old?.cancel()
    }

    // Used to avoid fetching in the middle of an ongoing fetch
    private var fetchActive = false

    // Page being fetched from unsplash
    private var currentPage: Int by observable(-1) { _, _ -&gt;
        fetchActive = true
        httpRequestJob = scope.launch {
            val results = client.get(unsplashLocation).body&lt;List&lt;UnsplashPhoto&gt;&gt;()

            loadedImages.addAll(results.mapNotNull { imageLoader.load(it.urls.small) })

            fetchActive = false

            if (nextPageNeeded) {
                nextPageNeeded = false
                currentPage += 1
            }
        }
    }

    private val pageSize               = 5
    private var nextPageNeeded         = false
    private val unsplashLocation get() = &quot;https://api.unsplash.com/photos/?client_id=$accessToken&amp;page=$currentPage&amp;per_page=$pageSize&quot;

    override val size get() = loadedImages.size

    override val changed = SetPool&lt;ModelObserver&lt;Image&gt;&gt;()

    // Internal list used to cache images loaded from unsplash
    private val loadedImages = ObservableList&lt;Image&gt;().also {
        it.changed += { _, differences -&gt;
            // notify model observers whenever the underlying list changes (due to image loads)
            changed.forEach {
                it(this, differences)
            }
        }
    }

    init {
        currentPage = 0
    }

    override fun get(index: Int): Result&lt;Image&gt; = Result.runCatching {
        loadedImages[index].also {
            // Load the next page if the last image is fetched from the model
            if (index == size - 1) {
                when {
                    fetchActive -&gt; nextPageNeeded = true
                    else        -&gt; currentPage += 1
                }
            }
        }
    }

    override fun contains(value: Image) = value in loadedImages
    override fun iterator(                       ) = loadedImages.iterator()
    override fun section (range: ClosedRange&lt;Int&gt;) = loadedImages.subList(range.start, range.endInclusive + 1)
}
//sampleEnd</code>
<p>Our model will cache a local <a href="https://nacular.github.io/doodle-api/core/io.nacular.doodle.utils/-observable-list" target="_blank" rel="noopener noreferrer"><code>ObservableList</code></a> of images via <code>loadedImages</code>. This list will provide the model state our list uses to render. The model will then fetch paginated images from Unsplash and load the resulting urls asynchronously into this list.</p>
<p>We track the <code>currentPage</code> and <code>pageSize</code> to fetch a growing list of pages from Unsplash. We fetch a new page whenever the <code>currentPage</code> is updated.</p>
<code theme="darcula" mode="kotlin" data-highlight-only="true">
class UnSplashDataModel(private val scope: CoroutineScope, /*...*/): DynamicListModel&lt;Image&gt; {
    // ...


    private var httpRequestJob: Job? by observable(null) { _,old,_ -&gt;
        old?.cancel()
    }


    private var currentPage: Int by observable(-1) { _,_ -&gt;
        fetchActive    = true
        httpRequestJob = scope.launch {
            val results = client.get&lt;List&lt;UnsplashPhoto&gt;&gt;(unsplashLocation)


            loadedImages.addAll(results.mapNotNull { imageLoader.load(it.urls.small) })


            fetchActive = false


            if (nextPageNeeded) {
                nextPageNeeded  = false
                currentPage    += 1
            }
        }
    }


    // ...
}
</code>
<p>Fetches are performed using Ktor&#x27;s HttpClient configured to read JSON data. These reads are done via Kotlin Serialization into the <code>UnsplashPhoto</code> data class. We only use the <code>small</code> value in the <code>urls</code> property from the JSON response, so our data classes are much simpler than the full Unsplash API.</p>
<code theme="darcula" mode="kotlin" data-highlight-only="true">
class UnSplashDataModel(httpClient: HttpClient, /*...*/): DynamicListModel&lt;Image&gt; {
    // ...


    @Serializable
    data class Urls(val small: String)


    @Serializable
    data class UnsplashPhoto(val id: String, val urls: Urls)


    // HTTP client configured to read JSON  returned from unsplash
    private val client = httpClient.config {
        install(JsonFeature) {
            serializer = KotlinxSerializer(Json { ignoreUnknownKeys = true })
        }
    }


    // ...
}
</code>
<p>Our <code>loadedImages</code> list triggers an event whenever we add a new set of images to it. We use this fact to notify of changes to the model, which get reflected by the <code>DynamicList</code>.</p>
<code theme="darcula" mode="kotlin" data-highlight-only="true">
class UnSplashDataModel(/*...*/): DynamicListModel&lt;Image&gt; {
    // ...


    override val changed = SetPool&lt;ModelObserver&lt;Image&gt;&gt;()


    // Internal list used to cache images loaded from unsplash
    private val loadedImages = ObservableList&lt;Image&gt;().also {
        it.changed += { _ ,removed, added, moved -&gt;
            // notify model observers whenever the underlying list changes (due to image loads)
            changed.forEach {
                it(this, removed, added, moved)
            }
        }
    }


    // ...
}
</code>
<p>Finally, we need to decide when to fetch more images. We do this whenever <code>get</code> is called on the last image of the model. This happens when the <code>DynamicList</code> needs to present that image, and is a good indication that it has reached the end.</p>
<code theme="darcula" mode="kotlin" data-highlight-only="true">
class UnSplashDataModel(/*...*/): DynamicListModel&lt;Image&gt; {
    // ...


    override fun get(index: Int): Image? = loadedImages.getOrNull(index).also {
        // Load the next page if the last image is fetched from the model
        if (index == size - 1) {
            when {
                fetchActive -&gt; nextPageNeeded  = true
                else        -&gt; currentPage    += 1
            }
        }
    }


    // ...
}
</code>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="presenting-the-images">Presenting The Images<a href="#presenting-the-images" class="hash-link" aria-label="Direct link to Presenting The Images" title="Direct link to Presenting The Images">​</a></h2>
<p>Our <code>DynamicList</code> holds a list of <code>Image</code> items, but these are not <code>View</code>s. Which means we need a way of visualizing them. Many Doodle containers use this concept of an <a href="https://nacular.github.io/doodle-api/controls/io.nacular.doodle.controls/-item-visualizer" target="_blank" rel="noopener noreferrer"><code>ItemVisualizer</code></a>. It is essentially a class that maps from some type <code>T</code> to <code>View</code> based on a set of inputs. <code>DynamicList</code> takes an <code>itemVisualizer</code> in its constructor that can be used by is <code>behavior</code> to render the contents of each row. Our app uses the <code>BasicListBehavior</code> to configure our list. Internally, that behavior takes the list&#x27;s visualizer and creates a new <code>View</code> that is wrapped in another that represents the row itself. So it is sufficient to specify a visualizer that renders our images.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>It is also possible to change the way <code>BasicListBehavior</code> (and any <code>ListBehavior</code>) represents its rows by specifying it&#x27;s <a href="https://nacular.github.io/doodle-api/controls/io.nacular.doodle.controls.theme/-tree-behavior/-row-generator" target="_blank" rel="noopener noreferrer"><code>RowGenerator</code></a>.</p></div></div>
<code theme="darcula" mode="kotlin" data-highlight-only="true">
class PhotoStreamApp(/*...*/): Application {
    init {
        // ...


        val list = DynamicList(
            model          = UnSplashDataModel(appScope, httpClient, imageLoader),
            itemVisualizer = itemVisualizer { image, recycledView, _ -&gt; when(recycledView) {
                is CenterCroppedPhoto -&gt; recycledView.also { recycledView.image = image }
                else                  -&gt; CenterCroppedPhoto(image)
            } }
        ).apply {
            behavior      = BasicListBehavior(rowHeight = imageHeight)
            cellAlignment = fill
        }
    }


    // ...
}
</code>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p><code>ItemVisualizer</code> is designed to support recycling. Each invocation may provide a recycled View that might be reusable for the new item. This lets us reuse the <code>CenterCroppedPhoto</code> instances as the list scrolls.</p></div></div>
<p>We will render each image as with a center-crop using <code>CenterCroppedPhoto</code>. This class holds an image that it renders with a centered square crop. The crop square&#x27;s length is equal to the image&#x27;s width or height (whichever is smaller). That center region is then scaled to fit the cropped photo View&#x27;s bounds.</p>
<code theme="darcula" mode="kotlin" data-highlight-only="true">package io.nacular.doodle.examples

import io.nacular.doodle.core.View
import io.nacular.doodle.drawing.Canvas
import io.nacular.doodle.geometry.Rectangle
import io.nacular.doodle.image.Image
import io.nacular.doodle.image.height
import io.nacular.doodle.image.width
import kotlin.math.min

/**
 * Renders an image with a center crop.
 */
//sampleStart
class CenterCroppedPhoto(image: Image): View() {
    private lateinit var centerCrop: Rectangle

    var image: Image = image
        set(new) {
            field        = new
            val cropSize = min(image.width, image.height)
            centerCrop   = Rectangle((image.width - cropSize) / 2, (image.height - cropSize) / 2, cropSize, cropSize)

            rerender()
        }

    init {
        this.image = image // ensure setter called, so centerCrop initialized
    }

    override fun render(canvas: Canvas) {
        canvas.image(image, source = centerCrop, destination = bounds.atOrigin)
    }
}
//sampleEnd</code></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/doodle-tutorials/docs/photos"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Photos</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#project-setup" class="table-of-contents__link toc-highlight">Project Setup</a></li><li><a href="#the-application" class="table-of-contents__link toc-highlight">The Application</a></li><li><a href="#binding-to-unsplash-data" class="table-of-contents__link toc-highlight">Binding To Unsplash Data</a></li><li><a href="#presenting-the-images" class="table-of-contents__link toc-highlight">Presenting The Images</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Nacular</div></div></div></footer></div>
</body>
</html>